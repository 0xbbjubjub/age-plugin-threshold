use std::str::FromStr;

/// Represents any Age identity, whether native or plugin.
pub enum AgeIdentity {
    X25519(age::x25519::Identity),
    Plugin(age::plugin::Identity),
}

impl AgeIdentity {
    pub fn from_bech32(s: &str) -> Result<Self, &str> {
        // FIXME: plugin support
        match age::x25519::Identity::from_str(s) {
            Ok(r) => Ok(Self::X25519(r)),
            Err("incorrect HRP") => Ok(Self::Plugin(age::plugin::Identity::from_str(s)?)),
            Err(err) => Err(err),
        }
    }

    pub fn to_identity<C: age::Callbacks>(
        &self,
        callbacks: C,
    ) -> Result<Box<dyn age::Identity>, String> {
        match self {
            Self::X25519(i) => Ok(Box::new(i.clone())),
            Self::Plugin(i) => {
                let plugin_name = i.plugin();
                match age::plugin::IdentityPluginV1::new(
                    // FIXME: use one instance per plugin
                    plugin_name,
                    &[i.clone()],
                    callbacks,
                ) {
                    Err(age::DecryptError::MissingPlugin { binary_name }) => Err(format!(
                        "No plugin found for {}: {}",
                        plugin_name, binary_name
                    )),
                    Ok(plugin) => Ok(Box::new(plugin)),
                    _ => panic!("unexpected error"),
                }
            }
        }
    }
}

#[cfg(test)]
mod tests {
    use super::AgeIdentity;
    use age_core::secrecy::ExposeSecret;

    #[test]
    fn test_example_no_plugin() {
        let example = "AGE-SECRET-KEY-1QL3Z7HJY54PW3HYWW5AYYFG7ZQGVC7W3J2ELW8ZMRJ2KG5SFN9AQGHWZHJ";
        assert!(
            matches!(AgeIdentity::from_bech32(example), Ok(AgeIdentity::X25519(actual)) if actual.to_string().expose_secret() == example)
        );
    }

    #[test]
    fn test_example_plugin() {
        let example = "AGE-PLUGIN-SIMPLEPQ-1QYPQQQ0MSQYMSG6PAZ6F8REYZCV9PC4JCUC076PH3XXJML60FGF0GCEJXSVZZCN77G5AWJFD6NQFMCLVKKK72ULTQ4DLP64WGV3HK6Z6J34GTJPURW7MQSFEPYUM7QM8KKRGE03W5WGHPCV7Z8FJLH24HA748WAEADW229PVAAW983JMHXHH4RW2QYCCTWSTY7RZEDXMDUFLNPCQTQXGCQAU7NYJDP6FEGPGK5C2Q69GYVN770THK04HKTTU25YU7S370QW0KCSPNR75PTVRZXD6QUPSS3DF7Z3F9UHPNPTR3QZVFQ7WGK3023QCRH2KC63EX0QQUZ4NGX56XX4ZPSU6C4KLQ98MFD203V5E3ZV5TJR2N6K4TTNKW3F85V7FK4R980EFQ0VA2DMU5W8J464DT4AUETCXTVYY089R6STMFKGU4GNUP0VY0EREK77THPKS5CVYVPAVLZMUEMFNSUPTY6WVCCAU5SPPP353CL7Q3YUPQTGFMUFXET5ZWWQG9934TTER2NRXCFYJE5DM2EVQE0Q2ZAR6SWYM453Q48U4P52E828XYHDLNZ7E43SR0FA9E8HNC4UHV526S6MSLD6S50A4K9QY0UJ6RNKET30MZCFYZNG5LNES2MFEQ65P43SY2HPSSA6369NCZ3QVVNQEJ22FF5U2U4ZGWHZMTGL2KCEU2JTZYZEHZHNTW63MJT932XMC49LDTXNUA0X9UE0YKHS726GRWYSRK2MNF0EPCD2QQWTLVAGQ0Z2QSWRFAY5JXQY4WDWXF2TNAGMTHJXXUTSG3YDHFFPXYM4E0Z4V2JEAVSZRA7WKSS3J3SXPT8YUYGQAQQ7G0US3RZ0HEPX2UCAPGZF3CX33ZY5HVFVK5KV7V9QTQDU2GYJVHS540QG75Q6PFZC00XYMMKN48LW5ZVUTVRY9SPGT0WAN5VTKSEG3H43FESUCFWXX0S5AWFQSA4EGK7E7SR796946LU46KCJMSZL50A0ATFCR2X0JFG507EYHD9HUKFF6CKG4URPLPEYJTD6Q6Q25RVLAH93CJ5VXH79U5CSPJAZCK4VTZRHWXENXX7S5G9DEAWQCE446J9ZG5Q36RWWTQFKFLWMH99PZR27L69XDXJMDAQNTF9NH05ENT0RV8GGPZQZHA9982UZZZN9ZTJ4UC6LEGZ3TYWQFVKSEY9PRTPNEWLXR2CWPRQMJWPQYN5Y8CXTNQYMCGXE24WN549Q4TQUVQM4H6EHGZFE3X42PWA3KVKRHNYSQ9VNPUCQEE9NZA6SKS8R3VSJNJSMVVJRLZ43C90RCG8J4YF46ZDM22MYYP5N9Z5SJEV0RW94QTGXCRDS2336JG4J4JAAEW65WVEQFE46J9P968FCPKKCK3YJAS7K58EK9L5569ZHEYXW6R8596WSNVVQJVS5T03F2QNKTGQD0UP3398ZYU4VXCYSCGPQKGNN6YXX46MPMC8XPCYR2X2K5V28CUZCXA49MHSYT7KSUGE4JJD9PHN83UAPLK5ECH4252S05X5236PP4VQDJ0TEEW6DUPAC6KQ2QMZT8ZFCFESAPGJM4W4Z5TGG3E3Q5ZUVZ9VMGNEXSDS5DJADCWFDFA5YYQ3RKD8SVFCWPTRMM0JRRUSC0ZAGERYUV2U7F808TTWG33KUUYJQ4Y9SZZNYYW3SHR9D5KEFMVNMK087TRXLUSYWJ9Q4T5YPMK8KGKS0508ZMGA6NVSAE62GWTCNX6KPRWY4R3XUFDPNZ76S7K76QZZYUFKTYRGU2PW4K2495AEYQZXTCZCKPYE22T8P9NFZTYYTU6S5QDF0SGR6W7SZEFGZLYM3ZJTRMD7W7Y8VXCTX33EUVMLKVZZVVELRTCCN5JYVYQ4M8K89KLL3ZHE6KJRCQL5D9JZJ3VJUMSJ73J2JZESP92Z0RL0YCPRA8AEAG548SZQJ55YT7HUGD3XC337YTX93XKZN2WVM4FUMEK46N6UXQPWRVDFCMRDCC6XRHL54Q55EUDM2EV9GWYEFM9UFFVHTUE69S2QA4Y3VWVD8VCQKFN96TA84X8P8NKNKHX4N5FPCAD99VCT7JK73AKSLVGC5W90ZCH3PT2U5H33JA9TDFJC5NJ2J63UN6DZ2X4YJEK0JX5SLFFTQWTPJ2TNXPJWHJ0P297PRUSXPHJ7F5VKJQHUX63SMG63HRJ3FVL7DCVK25K58UZULX39WDH7PZKM24PSDEXC9CFD5TMSYNP3M79TXZPPXJ3VY6ZLJRTSQTU4XYR9M247DF39S6WD2R69HQAZYKN7UHN0YVETNKXVK9N9VAZ2ZQQQUXAP7FRUX6X7GTKFQCSSE6PVF9X9Z8TLGCQLFNXFQAF5CJQQV3MLHMRF0UJFQGZECHYYV8V4J86LNQECYLSXCAYAE03YGA2RJ95F4P0PDCGV6YYC6MJPAZV4T6A9Q6YE8ZN8ECW70UCEM5TC4FSDQ52WX5VN27UED2YCZUALQUTZZR33E2Y50CKZJ3LWW0JC59MJN3REVJ40EZCQCZVSV0XV9JK6T9WZJVXCDZ5GFWM6D4GRC3PS0VN9H0CXYTUWCZKSEDUTA6YY73QGLAH0D3SJG5QZQ88KM9F5MQV2SY0QMECS7GEED4L0YYJLVJ4KQMGZTKEQZ4VSA5UEEQE8SYRSZ6K5CAYJDY2G7YRVU59VVXN07FDNSL83VQ8JMQCZAVXHACVLSKW6JZ8GSS8FDAR2XTMYAZ0M0HTQ9DKY6Q7UG7KTKFF3823EDWNYTFD9YY9VWQPU9T8YWNCJUD5ZUV7KHVRGADPJAVAHPZGFAS00F5HQPPLG9NUAJNVRVF0GQUJYEGZUD42HPPRRGSKZPFHYYJVPAHX9JVXQZVLMJC9MUXFULUNZVJ0YAJ3NQ5DCRZDCA6HFWQWETAVACCQUALUFCYH2C98TASPZJ9K3YL339276F9MUCC5MHKW7T5QXTQ8ZQXD5RQM3NJQVH3KJM37SA7K7SG72JYUURGP097DVREVUZV2F3G2WGYXCK29DEV0GFXXCN76F2MR5CCZ9AEKUZXR07UZ52LN890XRZJZ5Q4KD2MDQJC5WJLQ22NMWR9AGFHWTH7VD3CDJWRKE25Y8SQVTFS3VLKHJQZYQMS9PXDAN44VDQ23V5RCKHHXUT76JP4UUYG20LGDPCCNJCVCXT7S39W40T8CL7E5CNKVF5PS6GAYMXWGSU8W9865QZZY9FD6D4J042GCUM9WXZE228X006M675TC2G8GUZ52GHX2WPNHFWFMR9XJXK0F4EKPY44GYQ0RY0FQCJTYYYFPXFTQZCEEHWGQPZTU2VNSZAEEEX9MQ83TECG0W6MQGKXPUDYNH2NST9FC9R7D3HQKD035YTQEPW2NK64Y69M9ZAVEGLZ58QSNDU5CSVHZY0M55D55JY89PRE8RRP8CMSRC3DXPSD2YEPDQGQKJP6RXTFCKCUG6MER398YRQMPEMKHW2NJD4V0FJUA3TFZLPYMWE3XA8Z2YA8SW887ZRC33RCXRAX5UV8H7U5J8Y2CWKYZAF8T8JZY7Z2YEZ09GPCZDGH7C96385SV3UMEJ9GQ3A3GXLS3D6UVJ2YMHMURLPE52A4H2ZRLUN04H285LGE8ACKJR35LVN2VSFH9LTSYS0HZNV0W2L2VCGM6DYHA2U3XKSSF443RDA2QW3X99MDQTG2SPJH4P0W2ZHMUJ9M9K9SDUAGS2SVZN23N2DTCV6P723TNVJ3DQSV86AD5UNP0GVERJX9TCNMMWPMYPLJ5NK4F9X5V8CL8LYLHDTG7C5Q5XPA8JZQUJQL95MYK2TCDRF5HUUAE5D003ZQVSEVVZ6WASXSP209GPFQ9NUJSSJWL2QM38ZZYN5UZQ2YXDP324V0S3HU3YTHJFM57UH3XNCE90QKAC9QVKF6E3GGWD5K6URVV4C8ZLP9V4G";
        assert!(
            matches!(AgeIdentity::from_bech32(example), Ok(AgeIdentity::Plugin(actual)) if actual.to_string() == example)
        );
    }
}
